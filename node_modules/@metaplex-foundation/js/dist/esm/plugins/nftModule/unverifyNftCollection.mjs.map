{"version":3,"file":"unverifyNftCollection.mjs","sources":["../../../../src/plugins/nftModule/unverifyNftCollection.ts"],"sourcesContent":["import { Metaplex } from '@/Metaplex';\nimport { Operation, OperationHandler, Signer, useOperation } from '@/types';\nimport { Task, TransactionBuilder } from '@/utils';\nimport {\n  createUnverifyCollectionInstruction,\n  createUnverifySizedCollectionItemInstruction,\n} from '@metaplex-foundation/mpl-token-metadata';\nimport { ConfirmOptions, PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport { toMetadataAccount } from './accounts';\nimport { ParentCollectionMissingError } from './errors';\nimport { HasMintAddress, toMintAddress } from './helpers';\nimport { toMetadata } from './Metadata';\nimport type { NftBuildersClient } from './NftBuildersClient';\nimport type { NftClient } from './NftClient';\nimport {\n  findCollectionAuthorityRecordPda,\n  findMasterEditionV2Pda,\n  findMetadataPda,\n} from './pdas';\n\n// -----------------\n// Clients\n// -----------------\n\n/** @internal */\nexport function _unverifyNftCollectionClient(\n  this: NftClient,\n  nftOrSft: HasMintAddress,\n  input: Partial<Omit<UnverifyNftCollectionInput, 'mintAddress'>> = {}\n) {\n  return new Task(async (scope) => {\n    const mintAddress = toMintAddress(nftOrSft);\n    const collectionFromNft =\n      'collection' in nftOrSft && nftOrSft.collection\n        ? nftOrSft.collection.address\n        : undefined;\n    let collectionMintAddress =\n      input.collectionMintAddress ?? collectionFromNft;\n\n    if (!('collection' in nftOrSft) && !collectionMintAddress) {\n      const metadataAddress = findMetadataPda(mintAddress);\n      const metadata = toMetadata(\n        toMetadataAccount(await this.metaplex.rpc().getAccount(metadataAddress))\n      );\n      scope.throwIfCanceled();\n      collectionMintAddress = metadata.collection\n        ? metadata.collection.address\n        : undefined;\n    }\n\n    if (!collectionMintAddress) {\n      throw new ParentCollectionMissingError(mintAddress, 'unverifyCollection');\n    }\n\n    return this.metaplex.operations().execute(\n      unverifyNftCollectionOperation({\n        ...input,\n        mintAddress,\n        collectionMintAddress,\n      }),\n      scope\n    );\n  });\n}\n\n/** @internal */\nexport function _unverifyNftCollectionBuildersClient(\n  this: NftBuildersClient,\n  input: UnverifyNftCollectionBuilderParams\n) {\n  return unverifyNftCollectionBuilder(this.metaplex, input);\n}\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'UnverifyNftCollectionOperation' as const;\nexport const unverifyNftCollectionOperation =\n  useOperation<UnverifyNftCollectionOperation>(Key);\nexport type UnverifyNftCollectionOperation = Operation<\n  typeof Key,\n  UnverifyNftCollectionInput,\n  UnverifyNftCollectionOutput\n>;\n\nexport interface UnverifyNftCollectionInput {\n  // Accounts and models.\n  mintAddress: PublicKey;\n  collectionMintAddress: PublicKey;\n  collectionAuthority?: Signer; // Defaults to mx.identity().\n  payer?: Signer; // Defaults to mx.identity().\n\n  // Data.\n  isSizedCollection?: boolean; // Defaults to true.\n  isDelegated?: boolean; // Defaults to false.\n\n  // Options.\n  confirmOptions?: ConfirmOptions;\n}\n\nexport interface UnverifyNftCollectionOutput {\n  response: SendAndConfirmTransactionResponse;\n}\n\n// -----------------\n// Handler\n// -----------------\n\nexport const unverifyNftCollectionOperationHandler: OperationHandler<UnverifyNftCollectionOperation> =\n  {\n    handle: async (\n      operation: UnverifyNftCollectionOperation,\n      metaplex: Metaplex\n    ): Promise<UnverifyNftCollectionOutput> => {\n      return unverifyNftCollectionBuilder(\n        metaplex,\n        operation.input\n      ).sendAndConfirm(metaplex, operation.input.confirmOptions);\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\nexport type UnverifyNftCollectionBuilderParams = Omit<\n  UnverifyNftCollectionInput,\n  'confirmOptions'\n> & {\n  instructionKey?: string;\n};\n\nexport const unverifyNftCollectionBuilder = (\n  metaplex: Metaplex,\n  params: UnverifyNftCollectionBuilderParams\n): TransactionBuilder => {\n  const {\n    mintAddress,\n    collectionMintAddress,\n    isSizedCollection = true,\n    isDelegated = false,\n    collectionAuthority = metaplex.identity(),\n    payer = metaplex.identity(),\n  } = params;\n\n  const accounts = {\n    metadata: findMetadataPda(mintAddress),\n    collectionAuthority: collectionAuthority.publicKey,\n    payer: payer.publicKey,\n    collectionMint: collectionMintAddress,\n    collection: findMetadataPda(collectionMintAddress),\n    collectionMasterEditionAccount: findMasterEditionV2Pda(\n      collectionMintAddress\n    ),\n    collectionAuthorityRecord: isDelegated\n      ? findCollectionAuthorityRecordPda(\n          collectionMintAddress,\n          collectionAuthority.publicKey\n        )\n      : undefined,\n  };\n\n  const instruction = isSizedCollection\n    ? createUnverifySizedCollectionItemInstruction(accounts)\n    : createUnverifyCollectionInstruction(accounts);\n\n  return (\n    TransactionBuilder.make()\n      .setFeePayer(payer)\n\n      // Unverify the collection.\n      .add({\n        instruction: instruction,\n        signers: [payer, collectionAuthority],\n        key: params.instructionKey ?? 'unverifyCollection',\n      })\n  );\n};\n"],"names":["_unverifyNftCollectionClient","nftOrSft","input","Task","scope","mintAddress","toMintAddress","collectionFromNft","collection","address","undefined","collectionMintAddress","metadataAddress","findMetadataPda","metadata","toMetadata","toMetadataAccount","metaplex","rpc","getAccount","throwIfCanceled","ParentCollectionMissingError","operations","execute","unverifyNftCollectionOperation","_unverifyNftCollectionBuildersClient","unverifyNftCollectionBuilder","Key","useOperation","unverifyNftCollectionOperationHandler","handle","operation","sendAndConfirm","confirmOptions","params","isSizedCollection","isDelegated","collectionAuthority","identity","payer","accounts","publicKey","collectionMint","collectionMasterEditionAccount","findMasterEditionV2Pda","collectionAuthorityRecord","findCollectionAuthorityRecordPda","instruction","createUnverifySizedCollectionItemInstruction","createUnverifyCollectionInstruction","TransactionBuilder","make","setFeePayer","add","signers","key","instructionKey"],"mappings":"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"}