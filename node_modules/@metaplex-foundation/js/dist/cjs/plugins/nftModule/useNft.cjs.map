{"version":3,"file":"useNft.cjs","sources":["../../../../src/plugins/nftModule/useNft.ts"],"sourcesContent":["import { Metaplex } from '@/Metaplex';\nimport {\n  isSigner,\n  Operation,\n  OperationHandler,\n  Signer,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport { TransactionBuilder } from '@/utils';\nimport { createUtilizeInstruction } from '@metaplex-foundation/mpl-token-metadata';\nimport { ConfirmOptions, PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../rpcModule';\nimport { findAssociatedTokenAccountPda } from '../tokenModule';\nimport { ExpectedSignerError } from '@/errors';\nimport { HasMintAddress, toMintAddress } from './helpers';\nimport type { NftBuildersClient } from './NftBuildersClient';\nimport type { NftClient } from './NftClient';\nimport {\n  findMetadataPda,\n  findProgramAsBurnerPda,\n  findUseAuthorityRecordPda,\n} from './pdas';\n\n// -----------------\n// Clients\n// -----------------\n\n/** @internal */\nexport function _useNftClient(\n  this: NftClient,\n  nft: HasMintAddress,\n  input: Omit<UseNftInput, 'mintAddress'> = {}\n) {\n  return this.metaplex\n    .operations()\n    .getTask(useNftOperation({ ...input, mintAddress: toMintAddress(nft) }));\n}\n\n/** @internal */\nexport function _useNftBuildersClient(\n  this: NftBuildersClient,\n  input: UseNftBuilderParams\n) {\n  return useNftBuilder(this.metaplex, input);\n}\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'UseNftOperation' as const;\nexport const useNftOperation = useOperation<UseNftOperation>(Key);\nexport type UseNftOperation = Operation<typeof Key, UseNftInput, UseNftOutput>;\n\nexport interface UseNftInput {\n  // Accounts and models.\n  mintAddress: PublicKey;\n  numberOfUses?: number; // Defaults to 1.\n  owner?: PublicKey | Signer; // Defaults to mx.identity().\n  ownerTokenAccount?: PublicKey; // Defaults to associated token account.\n  useAuthority?: Signer; // Defaults to not being used.\n\n  // Options.\n  confirmOptions?: ConfirmOptions;\n}\n\nexport interface UseNftOutput {\n  response: SendAndConfirmTransactionResponse;\n}\n\n// -----------------\n// Handler\n// -----------------\n\nexport const useNftOperationHandler: OperationHandler<UseNftOperation> = {\n  handle: async (\n    operation: UseNftOperation,\n    metaplex: Metaplex\n  ): Promise<UseNftOutput> => {\n    return useNftBuilder(metaplex, operation.input).sendAndConfirm(\n      metaplex,\n      operation.input.confirmOptions\n    );\n  },\n};\n\n// -----------------\n// Builder\n// -----------------\n\nexport type UseNftBuilderParams = Omit<UseNftInput, 'confirmOptions'> & {\n  instructionKey?: string;\n};\n\nexport const useNftBuilder = (\n  metaplex: Metaplex,\n  params: UseNftBuilderParams\n): TransactionBuilder => {\n  const {\n    mintAddress,\n    numberOfUses = 1,\n    owner = metaplex.identity(),\n    useAuthority,\n  } = params;\n\n  if (!isSigner(owner) && !useAuthority) {\n    throw new ExpectedSignerError('owner', 'PublicKey', {\n      problemSuffix:\n        'In order to use an NFT you must either provide the owner as a Signer ' +\n        'or a delegated use authority as a Signer.',\n    });\n  }\n\n  const metadata = findMetadataPda(mintAddress);\n  const tokenAccount =\n    params.ownerTokenAccount ??\n    findAssociatedTokenAccountPda(mintAddress, toPublicKey(owner));\n  const useAuthorityRecord = useAuthority\n    ? findUseAuthorityRecordPda(mintAddress, useAuthority.publicKey)\n    : undefined;\n  const programAsBurner = findProgramAsBurnerPda();\n\n  return (\n    TransactionBuilder.make()\n\n      // Update the metadata account.\n      .add({\n        instruction: createUtilizeInstruction(\n          {\n            metadata,\n            tokenAccount,\n            useAuthority: useAuthority\n              ? useAuthority.publicKey\n              : toPublicKey(owner),\n            mint: mintAddress,\n            owner: toPublicKey(owner),\n            useAuthorityRecord,\n            burner: useAuthorityRecord ? programAsBurner : undefined,\n          },\n          { utilizeArgs: { numberOfUses } }\n        ),\n        signers: [owner, useAuthority].filter(isSigner),\n        key: params.instructionKey ?? 'utilizeNft',\n      })\n  );\n};\n"],"names":["_useNftClient","nft","input","metaplex","operations","getTask","useNftOperation","mintAddress","toMintAddress","_useNftBuildersClient","useNftBuilder","Key","useOperation","useNftOperationHandler","handle","operation","sendAndConfirm","confirmOptions","params","numberOfUses","owner","identity","useAuthority","isSigner","ExpectedSignerError","problemSuffix","metadata","findMetadataPda","tokenAccount","ownerTokenAccount","findAssociatedTokenAccountPda","toPublicKey","useAuthorityRecord","findUseAuthorityRecordPda","publicKey","undefined","programAsBurner","findProgramAsBurnerPda","TransactionBuilder","make","add","instruction","createUtilizeInstruction","mint","burner","utilizeArgs","signers","filter","key","instructionKey"],"mappings":"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"}